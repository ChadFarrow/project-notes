name: Sync GitHub Issues

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Sync Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPOS=(
            "MSP-2.0"
            "MSP-2.0-Desktop-App"
            "castr.me"
            "TRM-Lightning"
            "ITDV-Lightning"
            "HPM-Lightning"
            "stablekraft-app"
            "lnaddress-music"
            "musicL-playlist-updater"
            "chadf-musicl-playlists"
            "Auto-musicL-Maker"
            "RSS-music-site-template"
            "Helipad-to-Nostr-BoostBot"
            "LIT_Bot"
            "LibreRelayBot"
            "BoostAfterBoost"
            "chadf-landing-page"
            "HGH-checker"
            "lnurl-test-feed"
          )
          
          USERNAME="ChadFarrow"
          OUTPUT="ISSUES.md"
          
          echo "# GitHub Issues" > $OUTPUT
          echo "" >> $OUTPUT
          echo "*Auto-synced every 6 hours via GitHub Actions*" >> $OUTPUT
          echo "" >> $OUTPUT
          
          for repo in "${REPOS[@]}"; do
            echo "## $repo" >> $OUTPUT
            echo "" >> $OUTPUT
            
            # Get open issues
            open_issues=$(gh issue list --repo $USERNAME/$repo --state open --json number,title,url --jq '.[] | "- [#\(.number) \(.title)](\(.url))"' 2>/dev/null || echo "")
            
            # Get closed issues
            closed_issues=$(gh issue list --repo $USERNAME/$repo --state closed --json number,title,url --jq '.[] | "- [#\(.number)](\(.url)) âœ“ \(.title)"' 2>/dev/null || echo "")
            
            if [ -n "$open_issues" ]; then
              echo "### Open" >> $OUTPUT
              echo "$open_issues" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
            
            if [ -n "$closed_issues" ]; then
              echo "### Closed" >> $OUTPUT
              echo "$closed_issues" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
            
            if [ -z "$open_issues" ] && [ -z "$closed_issues" ]; then
              echo "*No issues*" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
          done
          
          echo "---" >> $OUTPUT
          echo "*Last synced: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $OUTPUT
      
      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add ISSUES.md
          git diff --staged --quiet || git commit -m "Auto-sync issues $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
