name: Sync GitHub Issues

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:  # Manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Sync Issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPOS=(
            "MSP-2.0"
            "MSP-2.0-Desktop-App"
            "castr.me"
            "TRM-Lightning"
            "ITDV-Lightning"
            "HPM-Lightning"
            "stablekraft-app"
            "lnaddress-music"
            "musicL-playlist-updater"
            "chadf-musicl-playlists"
            "Auto-musicL-Maker"
            "RSS-music-site-template"
            "Helipad-to-Nostr-BoostBot"
            "LIT_Bot"
            "LibreRelayBot"
            "BoostAfterBoost"
            "chadf-landing-page"
            "HGH-checker"
            "lnurl-test-feed"
          )
          
          USERNAME="ChadFarrow"
          OUTPUT="ISSUES.md"
          
          echo "# GitHub Issues" > $OUTPUT
          echo "" >> $OUTPUT
          echo "*Auto-synced every 6 hours via GitHub Actions*" >> $OUTPUT
          echo "" >> $OUTPUT
          
          for repo in "${REPOS[@]}"; do
            echo "## $repo" >> $OUTPUT
            echo "" >> $OUTPUT
            
            # Get open issues
            open_issues=$(gh issue list --repo $USERNAME/$repo --state open --json number,title,url --jq '.[] | "- [#\(.number) \(.title)](\(.url))"' 2>/dev/null || echo "")
            
            # Get closed issues
            closed_issues=$(gh issue list --repo $USERNAME/$repo --state closed --json number,title,url --jq '.[] | "- [#\(.number)](\(.url)) âœ“ \(.title)"' 2>/dev/null || echo "")
            
            if [ -n "$open_issues" ]; then
              echo "### Open" >> $OUTPUT
              echo "$open_issues" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
            
            if [ -n "$closed_issues" ]; then
              echo "### Closed" >> $OUTPUT
              echo "$closed_issues" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
            
            if [ -z "$open_issues" ] && [ -z "$closed_issues" ]; then
              echo "*No issues*" >> $OUTPUT
              echo "" >> $OUTPUT
            fi
          done
          
          echo "---" >> $OUTPUT
          echo "*Last synced: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $OUTPUT

          # ========== SYNC PULL REQUESTS ==========
          echo "Syncing pull requests..."
          PR_OUTPUT="PULL_REQUESTS.md"

          echo "# Pull Requests" > $PR_OUTPUT
          echo "" >> $PR_OUTPUT
          echo "*Auto-synced every 6 hours via GitHub Actions*" >> $PR_OUTPUT
          echo "" >> $PR_OUTPUT

          for repo in "${REPOS[@]}"; do
            echo "## $repo" >> $PR_OUTPUT
            echo "" >> $PR_OUTPUT

            open_prs=$(gh pr list --repo $USERNAME/$repo --state open --json number,title,url --jq '.[] | "- [#\(.number) \(.title)](\(.url))"' 2>/dev/null || echo "")
            merged_prs=$(gh pr list --repo $USERNAME/$repo --state merged --json number,title,url --jq '.[] | "- [#\(.number)](\(.url)) âœ“ \(.title)"' 2>/dev/null || echo "")

            if [ -n "$open_prs" ]; then
              echo "### Open" >> $PR_OUTPUT
              echo "$open_prs" >> $PR_OUTPUT
              echo "" >> $PR_OUTPUT
            fi

            if [ -n "$merged_prs" ]; then
              echo "### Merged" >> $PR_OUTPUT
              echo "$merged_prs" >> $PR_OUTPUT
              echo "" >> $PR_OUTPUT
            fi

            if [ -z "$open_prs" ] && [ -z "$merged_prs" ]; then
              echo "*No pull requests*" >> $PR_OUTPUT
              echo "" >> $PR_OUTPUT
            fi
          done

          echo "---" >> $PR_OUTPUT
          echo "*Last synced: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $PR_OUTPUT

      - name: Sync Branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPOS=(
            "MSP-2.0"
            "MSP-2.0-Desktop-App"
            "castr.me"
            "TRM-Lightning"
            "ITDV-Lightning"
            "HPM-Lightning"
            "stablekraft-app"
            "lnaddress-music"
            "musicL-playlist-updater"
            "chadf-musicl-playlists"
            "Auto-musicL-Maker"
            "RSS-music-site-template"
            "Helipad-to-Nostr-BoostBot"
            "LIT_Bot"
            "LibreRelayBot"
            "BoostAfterBoost"
            "chadf-landing-page"
            "HGH-checker"
            "lnurl-test-feed"
          )

          USERNAME="ChadFarrow"
          BR_OUTPUT="BRANCHES.md"

          echo "# Branches" > $BR_OUTPUT
          echo "" >> $BR_OUTPUT
          echo "*Auto-synced every 6 hours via GitHub Actions*" >> $BR_OUTPUT
          echo "" >> $BR_OUTPUT

          for repo in "${REPOS[@]}"; do
            echo "## $repo" >> $BR_OUTPUT
            echo "" >> $BR_OUTPUT

            branches=$(gh api repos/$USERNAME/$repo/branches --paginate --jq '.[] | "- `\(.name)`\(if .protected then " ðŸ”’" else "" end)"' 2>/dev/null || echo "")

            if [ -n "$branches" ]; then
              echo "$branches" >> $BR_OUTPUT
            else
              echo "*No branches found*" >> $BR_OUTPUT
            fi
            echo "" >> $BR_OUTPUT
          done

          echo "---" >> $BR_OUTPUT
          echo "*Last synced: $(date -u '+%Y-%m-%d %H:%M UTC')*" >> $BR_OUTPUT

      - name: Commit changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add ISSUES.md PULL_REQUESTS.md BRANCHES.md
          git diff --staged --quiet || git commit -m "Auto-sync issues $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
